<?php declare(strict_types=1); require_once __DIR__ . '/_bootstrap.php'; require_once __DIR__ . '/../../lib/db.php'; require_once __DIR__ . '/../../lib/app_features.php'; function e(string $v): string { return htmlspecialchars($v, ENT_QUOTES | ENT_SUBSTITUTE | ENT_HTML5, 'UTF-8'); }
$id=(int)($_GET['id']??0); $pdo=db(); $row=['slug'=>'','title'=>'','content'=>'','meta_title'=>'','meta_description'=>'','is_published'=>0]; if($id>0){$s=$pdo->prepare('SELECT * FROM pages WHERE id=:id');$s->execute([':id'=>$id]);$row=$s->fetch(PDO::FETCH_ASSOC)?:$row;}
$msg=''; if(($_SERVER['REQUEST_METHOD']??'GET')==='POST'){ if(!csrf_verify((string)($_POST['_token']??''))){$msg='CSRFエラー';} else { $slug=trim((string)$_POST['slug']);$title=trim((string)$_POST['title']);$content=sanitize_page_html((string)$_POST['content']);$mt=trim((string)$_POST['meta_title']);$md=trim((string)$_POST['meta_description']);$pub=isset($_POST['is_published'])?1:0; $chk=$pdo->prepare('SELECT id FROM pages WHERE slug=:slug AND id<>:id LIMIT 1');$chk->execute([':slug'=>$slug,':id'=>$id]); if($chk->fetch()){ $msg='slug重複'; } else { if($id>0){$st=$pdo->prepare('UPDATE pages SET slug=:slug,title=:title,content=:content,meta_title=:mt,meta_description=:md,is_published=:pub,updated_at=NOW() WHERE id=:id');$st->execute([':slug'=>$slug,':title'=>$title,':content'=>$content,':mt'=>$mt,':md'=>$md,':pub'=>$pub,':id'=>$id]);} else {$st=$pdo->prepare('INSERT INTO pages (slug,title,content,meta_title,meta_description,is_published,updated_at,created_at) VALUES (:slug,:title,:content,:mt,:md,:pub,NOW(),NOW())');$st->execute([':slug'=>$slug,':title'=>$title,':content'=>$content,':mt'=>$mt,':md'=>$md,':pub'=>$pub]);$id=(int)$pdo->lastInsertId();} header('Location: '.admin_url('pages.php')); exit; }}}
$pageTitle='固定ページ編集'; ob_start();?>
<h1>固定ページ編集</h1><?php if($msg!==''): ?><div class="admin-card"><?php echo e($msg); ?></div><?php endif; ?><form class="admin-card" method="post"><input type="hidden" name="_token" value="<?php echo e(csrf_token()); ?>"><label>Slug</label><input name="slug" value="<?php echo e((string)$row['slug']); ?>" required><label>Title</label><input name="title" value="<?php echo e((string)$row['title']); ?>" required><label>Content(HTML可)</label><textarea name="content" rows="12"><?php echo e((string)$row['content']); ?></textarea><label>Meta title</label><input name="meta_title" value="<?php echo e((string)$row['meta_title']); ?>"><label>Meta description</label><input name="meta_description" value="<?php echo e((string)$row['meta_description']); ?>"><label><input type="checkbox" name="is_published" value="1" <?php echo ((int)$row['is_published']===1)?'checked':''; ?>> 公開</label><button>保存</button></form><?php if($id>0): ?><form method="post" action="<?php echo e(admin_url('page_delete.php')); ?>" onsubmit="return confirm('削除しますか');"><input type="hidden" name="_token" value="<?php echo e(csrf_token()); ?>"><input type="hidden" name="id" value="<?php echo e((string)$id); ?>"><button>削除</button></form><?php endif; ?>
<?php $content=(string)ob_get_clean(); include __DIR__.'/../partials/admin_layout.php';
