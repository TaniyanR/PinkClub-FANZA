<?php declare(strict_types=1); require_once __DIR__ . '/_bootstrap.php'; require_once __DIR__ . '/../../lib/db.php'; require_once __DIR__ . '/../../lib/app_features.php'; function e(string $v): string { return htmlspecialchars($v, ENT_QUOTES | ENT_SUBSTITUTE | ENT_HTML5, 'UTF-8'); }
$pdo=db(); $msg=''; if(($_SERVER['REQUEST_METHOD']??'GET')==='POST' && csrf_verify((string)($_POST['_token']??''))){ if(isset($_POST['add'])){$st=$pdo->prepare('INSERT INTO rss_sources (name,feed_url,is_enabled) VALUES (:n,:u,1)');$st->execute([':n'=>trim((string)$_POST['name']),':u'=>trim((string)$_POST['feed_url'])]);$msg='追加';} if(isset($_POST['fetch_id'])){$res=rss_fetch_source((int)$_POST['fetch_id']);$msg=(string)$res['message'];}}
$rows=$pdo->query('SELECT * FROM rss_sources ORDER BY id DESC')->fetchAll(PDO::FETCH_ASSOC); $pageTitle='RSS管理'; ob_start();?><h1>RSS取得と表示</h1><?php if($msg!==''): ?><div class="admin-card"><?php echo e($msg); ?></div><?php endif; ?><form class="admin-card" method="post"><input type="hidden" name="_token" value="<?php echo e(csrf_token()); ?>"><input name="name" placeholder="name" required><input name="feed_url" placeholder="feed_url" required><button name="add" value="1">登録</button></form><div class="admin-card"><table><tr><th>name</th><th>url</th><th>last_fetched</th><th></th></tr><?php foreach($rows as $r): ?><tr><td><?php echo e((string)$r['name']); ?></td><td><?php echo e((string)$r['feed_url']); ?></td><td><?php echo e((string)$r['last_fetched_at']); ?></td><td><form method="post"><input type="hidden" name="_token" value="<?php echo e(csrf_token()); ?>"><input type="hidden" name="fetch_id" value="<?php echo e((string)$r['id']); ?>"><button>今すぐ更新</button></form></td></tr><?php endforeach; ?></table></div><?php $content=(string)ob_get_clean(); include __DIR__.'/../partials/admin_layout.php';
