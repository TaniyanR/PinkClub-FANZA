<?php declare(strict_types=1);

require_once __DIR__ . '/_bootstrap.php'; require_once __DIR__ . '/../lib/db.php'; require_once __DIR__ . '/../lib/csrf.php'; require_once __DIR__ . '/partials/_helpers.php'; function e2(string $v): string { return htmlspecialchars($v, ENT_QUOTES | ENT_SUBSTITUTE | ENT_HTML5, 'UTF-8'); } $err=''; $ok=''; if(($_SERVER['REQUEST_METHOD']??'GET')==='POST'){ if(!csrf_verify((string)($_POST['_token']??''))){$err='CSRFエラー';} else { $name=trim((string)$_POST['name']); $email=trim((string)$_POST['email']); $body=trim((string)$_POST['body']); if($name===''||$body===''||!filter_var($email,FILTER_VALIDATE_EMAIL)){$err='入力を確認してください';} else { $subject='[PinkClub] お問い合わせ'; $msg="name: {$name}\nemail: {$email}\n\n{$body}"; $sent=@mail((string)config_get('mail.to','admin@example.com'),$subject,$msg,"From: {$email}"); $st=db()->prepare('INSERT INTO mail_logs (created_at,from_email,subject,body,sent_ok,error_message) VALUES (NOW(),:e,:s,:b,:ok,:err)'); $st->execute([':e'=>$email,':s'=>$subject,':b'=>$msg,':ok'=>$sent?1:0,':err'=>$sent?null:'mail() failed']); $ok=$sent?'送信しました':'送信失敗（ログ保存済み）'; } }} $pageTitle='お問い合わせ'; include __DIR__.'/partials/header.php'; include __DIR__.'/partials/nav_search.php'; echo '<div class="layout">'; include __DIR__.'/partials/sidebar.php'; ?><main class="main-content"><section class="block"><h1 class="section-title">お問い合わせ</h1><?php if($err!==''): ?><p><?php echo e2($err); ?></p><?php endif; ?><?php if($ok!==''): ?><p><?php echo e2($ok); ?></p><?php endif; ?><form method="post"><input type="hidden" name="_token" value="<?php echo e2(csrf_token()); ?>"><label>名前</label><input name="name" required><label>メール</label><input name="email" type="email" required><label>本文</label><textarea name="body" rows="8" required></textarea><button>送信</button></form></section></main></div><?php include __DIR__.'/partials/footer.php';
